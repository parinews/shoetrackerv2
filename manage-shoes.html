<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ExerciseTrack2 - Manage Shoes</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <h1>Shoe Use Tracker</h1>
      <nav class="header-nav">
        <a href="index.html" class="nav-link">Summary</a>
        <a href="log-workout.html" class="nav-link">Log Workout</a>
        <a href="manage-shoes.html" class="nav-link active">Manage Shoes</a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <h2 class="mb-lg">Manage Shoes</h2>

    <!-- Alert Messages -->
    <div id="alert-container"></div>

    <!-- Add Shoe Form -->
    <div class="card">
      <h3 class="card-title">Add New Shoe</h3>
      <form id="add-shoe-form" class="form">
        <div class="form-group">
          <label for="shoe-name-input" class="form-label">Shoe Name</label>
          <input 
            type="text" 
            id="shoe-name-input" 
            class="form-input" 
            placeholder="Enter shoe name"
            required
          >
          <div class="form-helper">Must be unique</div>
        </div>
        <div class="form-group">
          <label for="shoe-image-input" class="form-label">Shoe Picture (Optional)</label>
          <input 
            type="file" 
            id="shoe-image-input" 
            class="form-input" 
            accept="image/*"
          >
          <div class="form-helper">Square images work best</div>
          <div id="image-preview" style="margin-top: var(--space-md); display: none;">
            <img id="preview-img" src="" alt="Preview" style="width: 150px; height: 150px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--border);">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">
          Add Shoe
        </button>
      </form>
    </div>

    <!-- Shoes List -->
    <div class="mt-lg">
      <h3 class="mb-lg">Your Shoes</h3>
      <div id="shoes-list"></div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-state-icon">ðŸ‘Ÿ</div>
      <h3 class="empty-state-title">No Shoes Yet</h3>
      <p class="empty-state-text">Add your first shoe using the form above.</p>
    </div>
  </main>

  <!-- Confirmation Modal Overlay -->
  <div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 25, 41, 0.5); z-index: 1000; backdrop-filter: blur(4px);"></div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; max-width: 500px; width: 90%;">
    <div class="card">
      <h3 class="card-title" id="modal-title">Confirm Action</h3>
      <p id="modal-message" style="margin: var(--space-lg) 0; color: var(--text-secondary);"></p>
      <div class="flex gap-md">
        <button id="modal-confirm" class="btn btn-danger">Confirm</button>
        <button id="modal-cancel" class="btn btn-outline">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Data storage script -->
  <script src="storage.js"></script>

  <!-- Page-specific script -->
  <script>
    /**
     * ExerciseTrack2 - Manage Shoes Page
     * Handles adding shoes, retiring shoes, and deleting shoes (if no workouts exist)
     */

    // Page elements
    const addShoeForm = document.getElementById('add-shoe-form');
    const shoeNameInput = document.getElementById('shoe-name-input');
    const shoeImageInput = document.getElementById('shoe-image-input');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const shoesList = document.getElementById('shoes-list');
    const emptyState = document.getElementById('empty-state');
    const alertContainer = document.getElementById('alert-container');
    
    // Modal elements
    const modalOverlay = document.getElementById('modal-overlay');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');

    // Modal state
    let modalCallback = null;

    /**
     * Initialize the page
     */
    function init() {
      renderShoes();
      
      // Add form submit listener
      addShoeForm.addEventListener('submit', handleAddShoe);

      // Image preview handler
      shoeImageInput.addEventListener('change', handleImagePreview);

      // Modal cancel button
      modalCancel.addEventListener('click', hideModal);
      modalOverlay.addEventListener('click', hideModal);
    }

    /**
     * Handle image preview
     */
    function handleImagePreview(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          previewImg.src = event.target.result;
          imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        imagePreview.style.display = 'none';
        previewImg.src = '';
      }
    }

    /**
     * Convert image file to base64
     * @param {File} file - Image file
     * @returns {Promise<string>} Base64 string
     */
    function imageToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          resolve(event.target.result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**
     * Render all shoes
     */
    function renderShoes() {
      const shoes = Storage.getShoes();

      if (shoes.length === 0) {
        shoesList.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      shoesList.style.display = 'block';
      emptyState.style.display = 'none';
      shoesList.innerHTML = '';

      shoes.forEach(shoe => {
        const card = createShoeCard(shoe);
        shoesList.appendChild(card);
      });
    }

    /**
     * Create a shoe card element
     * @param {Object} shoe - Shoe object
     * @returns {HTMLElement} Card element
     */
    function createShoeCard(shoe) {
      const totalMiles = Storage.getTotalMiles(shoe.id);
      const workouts = Storage.getWorkoutsByShoe(shoe.id);
      const hasWorkouts = workouts.length > 0;

      const card = document.createElement('div');
      card.className = 'card fade-in';

      card.innerHTML = `
        <div class="card-header">
          <div class="shoe-header-content">
            <div class="shoe-info">
              <h3 class="shoe-name">${escapeHtml(shoe.name)}</h3>
              <span class="shoe-status ${shoe.retired ? 'status-retired' : 'status-active'}">
                ${shoe.retired ? 'Retired' : 'Active'}
              </span>
            </div>
            ${shoe.imageData ? `<img src="${shoe.imageData}" alt="${escapeHtml(shoe.name)}" class="shoe-image">` : '<div class="shoe-image-placeholder">ðŸ‘Ÿ</div>'}
          </div>
          <div>
            <div class="shoe-miles">${totalMiles.toLocaleString()}</div>
            <div class="miles-label">Total Miles</div>
          </div>
        </div>
        <div class="shoe-actions">
          ${!shoe.retired ? `
            <button class="btn btn-outline btn-small" onclick="retireShoe('${shoe.id}')">
              Retire
            </button>
          ` : ''}
          ${!hasWorkouts ? `
            <button class="btn btn-danger btn-small" onclick="deleteShoe('${shoe.id}')">
              Delete
            </button>
          ` : ''}
          <a href="workouts.html?shoe=${shoe.id}" class="btn btn-secondary btn-small">
            View Workouts (${workouts.length})
          </a>
        </div>
      `;

      return card;
    }

    /**
     * Handle adding a new shoe
     */
    async function handleAddShoe(e) {
      e.preventDefault();

      // Clear previous alerts
      alertContainer.innerHTML = '';

      const name = shoeNameInput.value.trim();

      if (!name) {
        showAlert('Please enter a shoe name', 'error');
        return;
      }

      try {
        let imageData = null;
        const imageFile = shoeImageInput.files[0];
        
        if (imageFile) {
          // Validate file type
          if (!imageFile.type.startsWith('image/')) {
            showAlert('Please select a valid image file', 'error');
            return;
          }
          
          // Validate file size (max 2MB)
          if (imageFile.size > 2 * 1024 * 1024) {
            showAlert('Image size must be less than 2MB', 'error');
            return;
          }
          
          imageData = await imageToBase64(imageFile);
        }

        Storage.addShoe(name, imageData);
        shoeNameInput.value = '';
        shoeImageInput.value = '';
        imagePreview.style.display = 'none';
        previewImg.src = '';
        showAlert(`"${name}" added successfully!`, 'success');
        renderShoes();
      } catch (error) {
        showAlert(error.message, 'error');
      }
    }

    /**
     * Retire a shoe (with confirmation)
     * @param {string} shoeId - Shoe ID to retire
     */
    window.retireShoe = function(shoeId) {
      const shoe = Storage.getShoeById(shoeId);
      if (!shoe) return;

      showModal(
        'Retire Shoe',
        `Are you sure you want to retire "${shoe.name}"? It will no longer appear in the workout dropdown but will remain visible in your summary.`,
        () => {
          Storage.retireShoe(shoeId);
          showAlert(`"${shoe.name}" has been retired`, 'success');
          renderShoes();
          hideModal();
        }
      );
    };

    /**
     * Delete a shoe (with confirmation, only if no workouts)
     * @param {string} shoeId - Shoe ID to delete
     */
    window.deleteShoe = function(shoeId) {
      const shoe = Storage.getShoeById(shoeId);
      if (!shoe) return;

      const workouts = Storage.getWorkoutsByShoe(shoeId);
      if (workouts.length > 0) {
        showAlert('Cannot delete a shoe with existing workouts', 'error');
        return;
      }

      showModal(
        'Delete Shoe',
        `Are you sure you want to permanently delete "${shoe.name}"? This action cannot be undone.`,
        () => {
          const success = Storage.deleteShoe(shoeId);
          if (success) {
            showAlert(`"${shoe.name}" has been deleted`, 'success');
            renderShoes();
          } else {
            showAlert('Cannot delete a shoe with existing workouts', 'error');
          }
          hideModal();
        }
      );
    };

    /**
     * Show confirmation modal
     * @param {string} title - Modal title
     * @param {string} message - Modal message
     * @param {Function} callback - Function to call on confirm
     */
    function showModal(title, message, callback) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalCallback = callback;

      modalOverlay.style.display = 'block';
      confirmationModal.style.display = 'block';

      // Set up confirm button
      modalConfirm.onclick = () => {
        if (modalCallback) {
          modalCallback();
        }
      };
    }

    /**
     * Hide confirmation modal
     */
    function hideModal() {
      modalOverlay.style.display = 'none';
      confirmationModal.style.display = 'none';
      modalCallback = null;
    }

    /**
     * Show an alert message
     * @param {string} message - Alert message
     * @param {string} type - Alert type (success, error, warning, info)
     */
    function showAlert(message, type = 'info') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} fade-in`;
      alert.textContent = message;
      alertContainer.appendChild(alert);

      // Auto-dismiss success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      // Scroll to top to ensure alert is visible
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
